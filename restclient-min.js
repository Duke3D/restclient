/**
 * @class RCBase64
 * This class Encode and Decode Base64
 * @singleton
 */
var RCBase64={keyStr:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",encode:function(e){var t="",n,r,i,s,o,u,a,f=0;e=this.utf8_encode(e);while(f<e.length)n=e.charCodeAt(f++),r=e.charCodeAt(f++),i=e.charCodeAt(f++),s=n>>2,o=(n&3)<<4|r>>4,u=(r&15)<<2|i>>6,a=i&63,isNaN(r)?u=a=64:isNaN(i)&&(a=64),t=t+this.keyStr.charAt(s)+this.keyStr.charAt(o)+this.keyStr.charAt(u)+this.keyStr.charAt(a);return t},decode:function(e){var t="",n,r,i,s,o,u,a,f=0;e=e.replace(/[^A-Za-z0-9\+\/\=]/g,"");while(f<e.length)s=this.keyStr.indexOf(e.charAt(f++)),o=this.keyStr.indexOf(e.charAt(f++)),u=this.keyStr.indexOf(e.charAt(f++)),a=this.keyStr.indexOf(e.charAt(f++)),n=s<<2|o>>4,r=(o&15)<<4|u>>2,i=(u&3)<<6|a,t+=String.fromCharCode(n),u!==64&&(t+=String.fromCharCode(r)),a!==64&&(t+=String.fromCharCode(i));return t=this.utf8_decode(t),t},utf8_encode:function(e){e=e.replace(/\r\n/g,"\n");var t="",n,r;for(n=0;n<e.length;n++)r=e.charCodeAt(n),r<128?t+=String.fromCharCode(r):r>127&&r<2048?(t+=String.fromCharCode(r>>6|192),t+=String.fromCharCode(r&63|128)):(t+=String.fromCharCode(r>>12|224),t+=String.fromCharCode(r>>6&63|128),t+=String.fromCharCode(r&63|128));return t},utf8_decode:function(e){var t="",n=0,r=0,i=0,s=0;while(n<e.length)r=e.charCodeAt(n),r<128?(t+=String.fromCharCode(r),n++):r>191&&r<224?(i=e.charCodeAt(n+1),t+=String.fromCharCode((r&31)<<6|i&63),n+=2):(i=e.charCodeAt(n+1),s=e.charCodeAt(n+2),t+=String.fromCharCode((r&15)<<12|(i&63)<<6|s&63),n+=3);return t}},RestClient;RestClient=function(){this.VERSION="0.1.4",this.authorization={},this.server={},this.response={},this.headers={},this.accessToken={},this.autoUseRefreshToken=!0,this.autoStoreAccessToken=!0,this.authorizationType="none",this.contentType="application/x-www-form-urlencoded",this.sendOAuthBearerAuthorization=!1,this.oauth2NeedsAuthorization=!0,this.RESTMethods={create:"POST",read:"GET",update:"PUT","delete":"DELETE"},this.OAUTH2GrantTypes={code:"authorization_code",implicit:"token",user:"password",client:"client_credentials",refresh:"refresh_token"},RestClient.prototype.initObject.call(this)},RestClient.prototype.HTTP_SUCCESS=200,RestClient.prototype.HTTP_BAD_REQUEST=400,RestClient.prototype.HTTP_UNAUTHORIZED=401,RestClient.prototype.initObject=function(){this.authorization={},this.server={},this.response={},this.headers={},this.accessToken={},this.autoUseRefreshToken=!0,this.autoStoreAccessToken=!0,this.authorizationType="none",this.contentType="application/x-www-form-urlencoded",this.sendOAuthBearerAuthorization=!1,this.oauth2NeedsAuthorization=!0},RestClient.prototype.setUseRefreshTokenAutomatically=function(e){return _.isBoolean(e)&&(this.autoUseRefreshToken=e),this},RestClient.prototype.setStoreAccessTokenAutomatically=function(e){return _.isBoolean(e)&&(this.autoStoreAccessToken=e),this},RestClient.prototype.setAuthorizationType=function(e){var t={none:1,basic:1,oauth2:1};return t[e]&&(this.authorizationType=e),this},RestClient.prototype.setContentType=function(e){return this.contentType=e,this},RestClient.prototype.setSendBearerAuthorization=function(e){return _.isBoolean(e)&&(this.sendOAuthBearerAuthorization=e),this},RestClient.prototype.setOAuth2NeedsAuthorization=function(e){return _.isBoolean(e)&&(this.oauth2NeedsAuthorization=e),this},RestClient.prototype.getVersion=function(){return this.VERSION},RestClient.prototype.setClient=function(e,t,n){return this.authorization.client_id=e,this.authorization.client_secret=t,this.authorization.client_url=n!=="undefined"?n:null,this},RestClient.prototype.setGrantType=function(e,t){return this.authorization.grant_type=this.OAUTH2GrantTypes[e]!=="undefined"?this.OAUTH2GrantTypes[e]:null,this.authorization=_.extend(this.authorization,t),this},RestClient.prototype.setAuthorizationServer=function(e){var t=!0,n;return typeof e=="undefined"||e===null?t=!1:(n=/(http|https):\/\/(\w+:{0,1}\w*@)?(\S+)(:[0-9]+)?(\/|\/([\w#!:.?+=&%@!\-\/]))?/,e.match(n)?this.server.rest_auth_uri=e:t=!1),t},RestClient.prototype.setHeader=function(e,t){var n=!0,r;return e&&t?(r=JSON.parse('{"'+e+'" :  "'+t+'"}'),this.headers=_.extend(this.headers,r)):n=!1,n},RestClient.prototype.setBasicCredentials=function(e,t){return this.authorization.basic_user=e,this.authorization.basic_password=t,this},RestClient.prototype.setAccessToken=function(e){return typeof e=="object"&&(this.accessToken=e),this},RestClient.prototype.toParams=function(e){var t=_.keys(e),n=[];return _.each(t,function(t){n.push(t+"="+e[t])}),n.join("&")},RestClient.prototype.prepareBody=function(e){var t="";return this.contentType==="application/json"?typeof e=="object"&&(t=JSON.stringify(e)):t=this.toParams(e),t},RestClient.prototype.createXHR=function(){var e;if(window.XMLHttpRequest)e=new XMLHttpRequest;else if(!!window.ActiveXObject)try{e=new ActiveXObject("MSXML2.XMLHTTP")}catch(t){try{e=new ActiveXObject("Microsoft.XMLHTTP")}catch(n){}}return e?e:!1},RestClient.prototype.authorize=function(e){var t=this,n=!1,r="create",i=this.RESTMethods[r],s,o,u,a;s=RCBase64.encode(this.authorization.client_id+":"+this.authorization.client_secret),o=this.createXHR();try{o.open(i,this.server.rest_auth_uri,!1)}catch(f){return e.xhrfailure?e.xhrfailure(f,{}):this.XHRFailure(f,{}),n}o.onreadystatechange=function(){e.ready?e.ready(o):t.AuthorizeReady(o);if(o.readyState===4)if(o.status===this.HTTP_SUCCESS)try{a=JSON.parse(o.responseText),t.autoStoreAccessToken&&(t.accessToken=a.token?a.token:{}),n=!0,e.success?e.success(o,a):t.AuthorizeSuccess(o,a)}catch(r){a={success:!1,error:{error:this.HTTP_BAD_REQUEST,error_description:"Response is not a valid JSON"}},e.failure?e.failure(o,a):t.AuthorizeFailure(o,a)}else{a={};try{a=JSON.parse(o.responseText)}catch(r){}e.failure?e.failure(o,a):t.AuthorizeFailure(o,a)}},u={};if(this.authorization.grant_type){u.grant_type=this.authorization.grant_type;switch(this.authorization.grant_type){case"authorization_code":u.code=this.authorization.code;break;case"token":u.token=this.authorization.token;break;case"password":u.username=this.authorization.username,u.password=this.authorization.password;break;case"client_credentials":u.client_id=this.authorization.client_id,u.client_id=this.authorization.client_secret;break;case"refresh_token":u.refresh_token=this.authorization.refresh_token}}return this.oauth2NeedsAuthorization&&o.setRequestHeader("Authorization","Basic "+s),o.setRequestHeader("Content-Type",this.contentType),_.each(this.headers,function(e,t){o.setRequestHeader(t,e)}),o.send(this.prepareBody(u)),n},RestClient.prototype.prepareReqFields=function(e){var t;return t={success:!1,error:{error:this.HTTP_BAD_REQUEST,error_description:"Required fields not found"},fields:e},t},RestClient.prototype.prepareConsumeUrl=function(e,t,n,r){var i,s,o=!1;switch(e){case"read":i=t,n&&(i+=n),this.authorizationType==="oauth2"&&!this.sendOAuthBearerAuthorization&&(o=!0,i+="?access_token="+this.accessToken.access_token),r&&(o?i+="&":i+="?",i+=this.toParams(r)),s=null;break;case"create":i=t,s=r||{},this.authorizationType==="oauth2"&&!this.sendOAuthBearerAuthorization&&(s.access_token=this.accessToken.access_token),s=this.prepareBody(s);break;case"update":i=t,n&&(i+=n),s=r||{},this.authorizationType==="oauth2"&&!this.sendOAuthBearerAuthorization&&(s.access_token=this.accessToken.access_token),s=this.prepareBody(s);break;case"delete":i=t,n&&(i+=n),s=r||{},this.authorizationType==="oauth2"&&!this.sendOAuthBearerAuthorization&&(s.access_token=this.accessToken.access_token),s=this.prepareBody(s)}return{url:i,body:s}},RestClient.prototype.getCall=function(e){return e.operation="read",this.consume(e)},RestClient.prototype.postCall=function(e){return e.operation="create",this.consume(e)},RestClient.prototype.putCall=function(e){return e.operation="update",this.consume(e)},RestClient.prototype.deleteCall=function(e){return e.operation="delete",this.consume(e)},RestClient.prototype.consume=function(e){var t,n,r,i,s={},o,u,a,f,l=!0,c,h=[],p,d,v,m;e.operation?r=e.operation:(l=!1,h.push("operation")),e.url?c=e.url:(l=!1,h.push("url")),p=e.data?e.data:{},d=e.id?e.id:null;if(!l)return e.failure?e.failure(null,this.prepareReqFields(h)):this.ConsumeFailure(null,this.prepareReqFields(h)),l;v=this.prepareConsumeUrl(r,c,d,p),u=v.url,o=v.body,n=this.createXHR();switch(this.authorizationType){case"none":break;case"basic":t=RCBase64.encode(this.authorization.basic_user+":"+this.authorization.basic_user),n.setRequestHeader("Authorization","Basic "+t);break;case"oauth2":if(!this.accessToken.access_token)return l=!1,h.push("access_token"),f={success:!1,error:{error:this.HTTP_BAD_REQUEST,error_description:"Access Token not defined"}},e.failure?e.failure(null,this.prepareReqFields(h)):this.ConsumeFailure(null,this.prepareReqFields(h)),l;this.sendOAuthBearerAuthorization&&(m="Bearer: "+this.accessToken.access_token,n.setRequestHeader("Authorization",m))}i=this.RESTMethods[r];try{n.open(i,u,!1)}catch(g){return e.xhrfailure?e.xhrfailure(g,p):this.XHRFailure(g,p),!1}return a=this,n.onreadystatechange=function(){e.ready?e.ready(n):a.ConsumeReady(n);if(n.readyState===4)if(n.status===this.HTTP_SUCCESS)try{s=JSON.parse(n.responseText),e.success?e.success(n,s):a.ConsumeSuccess(n,s)}catch(t){s={success:!1,error:{error:this.HTTP_BAD_REQUEST,error_description:"Response is not a valid JSON"}},e.failure?e.failure(n,s):a.ConsumeFailure(n,s)}else if(n.status===this.HTTP_UNAUTHORIZED&&a.autoUseRefreshToken)a.accessToken.refresh_token?(a.setGrantType("refresh",{refresh_token:a.accessToken.refresh_token}),a.authorize({success:function(t,n){l=a.consume(e),l&&(e.autorefresh?e.autorefresh(a.accessToken):a.AuthorizeAutoRefresh(a.accessToken))},failure:function(t,n){l=!1,e.failure?e.failure(null,n):a.ConsumeFailure(null,n)}})):(l=!1,s={success:!1,error:{error:this.HTTP_UNAUTHORIZED,error_description:"Refresh token is not defined"}},e.failure?e.failure(n,s):a.ConsumeFailure(n,s));else{l=!1,s={};try{s=JSON.parse(n.responseText)}catch(t){}e.failure?e.failure(n,s):a.ConsumeFailure(n,s)}},n.setRequestHeader("Content-Type",this.contentType),_.each(this.headers,function(e,t){n.setRequestHeader(t,e)}),n.send(o),l},RestClient.prototype.XHRFailure=function(e,t){},RestClient.prototype.AuthorizeSuccess=function(e,t){},RestClient.prototype.AuthorizeFailure=function(e,t){},RestClient.prototype.AuthorizeReady=function(e){},RestClient.prototype.AuthorizeAutoRefresh=function(e){},RestClient.prototype.ConsumeSuccess=function(e,t){},RestClient.prototype.ConsumeFailure=function(e,t){},RestClient.prototype.ConsumeReady=function(e){};if(typeof exports!="undefined"){module.exports=RestClient;var _=require("underscore")};